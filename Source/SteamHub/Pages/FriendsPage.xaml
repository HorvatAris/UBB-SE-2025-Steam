<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="SteamHub.Pages.FriendsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:SteamHub.ApiContract.Models"
    xmlns:vm="using:SteamHub.ViewModels"
    xmlns:converters="using:SteamHub.Pages.Converters"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter" />
        <DataTemplate x:Key="FriendItemTemplate" x:DataType="models:Friendship"   >
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Padding="12"
                    Margin="8"
                    Width="240">
                <StackPanel Spacing="12">
                    <!-- Profile Picture -->
                    <Image Source="{Binding FriendProfilePicture}"
                           Stretch="UniformToFill"
                           Height="120"
                           Width="120"
                           HorizontalAlignment="Center"/>

                    <!-- Username -->
                    <TextBlock Text="{Binding FriendUsername}"
                               Style="{ThemeResource BodyStrongTextBlockStyle}"
                               TextWrapping="NoWrap"
                               TextTrimming="CharacterEllipsis"
                               TextAlignment="Center"/>

                    <!-- Action Buttons -->
                    <StackPanel Orientation="Horizontal" 
                                HorizontalAlignment="Center"
                                Spacing="8">
                        <Button Content="View"
                                Command="{Binding DataContext.ViewFriendCommand,ElementName=PageRoot}"
                                CommandParameter="{Binding FriendId}"
                                Style="{StaticResource AccentButtonStyle}"
                                MinWidth="80"/>

                        <Button Content="Chat"
                                Command="{Binding ChatFriendCommand}"
                                CommandParameter="{Binding FriendId}"
                                Style="{StaticResource AccentButtonStyle}"
                                MinWidth="80"/>

                        <Button Content="Remove"
                                Command="{Binding DataContext.RemoveFriendshipCommand, ElementName=PageRoot}"
                                CommandParameter="{Binding FriendshipId}"
                                Style="{StaticResource AccentButtonStyle}"
                                MinWidth="80"/>



                    </StackPanel>
                </StackPanel>
            </Border>
        </DataTemplate>
    </Page.Resources>

    <Grid x:Name="PageRoot"
          Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="20" Spacing="12">

            <TextBlock Text="FRIENDS" 
                       FontSize="30" 
                       FontWeight="Bold"
                       VerticalAlignment="Center"/>
        </StackPanel>

        <!-- Loading and Error Indicators -->
        <StackPanel Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center">
            <ProgressRing IsActive="{Binding IsLoading}"
                          Width="50" 
                          Height="50"
                          Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"/>

            <TextBlock Text="{Binding ErrorMessage}"
                       Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                       TextWrapping="Wrap"
                       TextAlignment="Center"
                       Visibility="{Binding ErrorMessage, Converter={StaticResource StringToVisibilityConverter}}"/>
        </StackPanel>

        <!-- Friends List -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="20" Spacing="20">
                <TextBlock Text="MY FRIENDS" 
                           FontSize="20" 
                           FontWeight="Bold"/>

                <!-- Using ItemsWrapGrid instead of WrapPanel -->
                <ItemsControl ItemsSource="{Binding Friendships}"
                              ItemTemplate="{StaticResource FriendItemTemplate}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <ItemsWrapGrid Orientation="Horizontal" 
                                          MaximumRowsOrColumns="3"
                                          HorizontalAlignment="Center"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>